# Overview

This project is used for Gradle build performance monitoring, it consist of 2 parts:

1. Gradle metrics generator - [GradlePrometheusPlugin.kt](./src/main/kotlin/io/johnsonlee/gradle/metrics/GradlePrometheusPlugin.kt)

    [Prometheus](https://prometheus.io) metrics generator for Gradle project
    
1. Gradle metrics exporter - [exporter/index.js](./exporter/index.js)

    Export metrics to [Prometheus](https://prometheus.io) service, the metrics can be visualized by [Grafana](https://grafana.com)

Using this project, we can build a pretty dashboard:

![Screenshot](./art/screenshot.png)

## Prerequisite

- Docker
- Docker Compose
- Prometheus

    You can refer [dockerify/prometheus](https://github.com/johnsonlee/dockerify/tree/main/prometheus) to deploy your own Prometheus service.

- Grafana

    You can refer [dockerify/grafana](https://github.com/johnsonlee/dockerify/tree/main/grafana) to deploy your own Grafana service

## Getting Started

### Start Metrics Exporter

The metrics exporter can be easily start by the following command:

```bash
cd exporter && docker-compose up -d \
    -e REDIS_HOST=<redis-host> \
    -e REDIS_PORT=<redis-port> \
    -e REDIS_KEY=${groupId}:${artifactId}
```

For example:

```bash
cd exporter && docker-compose up -d \
    -e REDIS_HOST=192.168.1.5 \
    -e REDIS_PORT=6379 \
    -e REDIS_KEY=io.johnsonlee.gradle:gradle-prometheus-plugin
```

> The default value of `REDIS_HOST` is `127.0.0.1` 
>
> The default value of `REDIS_PORT` is `6379`

You can put the environment variables into `.env` file with `docker-compose.yml`:

```
REDIS_HOST=192.168.1.5
REDIS_PORT=6379
REDIS_KEY=io.johnsonlee.gradle:gradle-prometheus-plugin
```

### Publish Metrics Exporter

To make the metrics exporter service discoverable by Prometheus service, you have to update [prometheus.yml](https://github.com/johnsonlee/dockerify/blob/main/prometheus/prometheus.yml):

```
scrape_configs:
- job_name: cadvisor
  scrape_interval: 5s
  static_configs:
  - targets:
    - cadvisor:8080
- job_name: gradle-prometheus-exporter
  scrape_interval: 5s
  static_configs:
  - targets:
    - <the-ip-address-of-exporter>:9300
```

After updated, restart prometheus service by executing the following command:

```bash
docker-compose restart promethues
```

### Integrate Metrics Generator

The gradle plugin can by easily integrated by [Gradle Initialization Scripts](https://docs.gradle.org/current/userguide/init_scripts.html) with Gradle project, just put [init.gradle](https://github.com/johnsonlee/gradle-prometheus-plugin/blob/main/src/main/resources/init.gradle) under one of following directories:

1. *USER_HOME/.gradle/*
1. *USER_HOME/.gradle/init.d/*
1. *GRADLE_HOME/init.d/*

Then build gradle project with 2 properties:

1. *redis.host* (default is *127.0.0.1*)
1. *redis.port* (default is *6379*)

```bash
./gradlew -Predis.host=192.168.1.5 assemble
```

After build finished, the metrics is supposed to be put into Redis with key `${git-repo-owner}:${project.name}`.

### Create Dashboard for Gradle Metrics

If everything works well, the metrics generated by Gradle plugin are supposed to be discovered by Prometheus as following:

- gradle_project_evaluation_duration_ms
- gradle_settings_duration_ms
- gradle_task_execution_duration_ms
- gradle_build_duration_ms

Then, we can create dashboard with those metrics.

